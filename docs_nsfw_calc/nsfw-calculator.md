# NSFW Score Calculator v0.5 — техническая документация

## Назначение

Веб-калькулятор для оценки степени NSFW-контента на изображении. Принимает изображение, отправляет его в Vision-модель через OpenRouter API, получает числовые оценки по четырём осям и вычисляет итоговый балл по формуле noisy-OR. Все промежуточные значения можно вводить и корректировать вручную.

---

## Поток вычислений

1. N — Nudity. 8 зон тела (2×4). Каждая: вес × открытость.
  - В самом верху секции - переключатель пола `[Жен / Муж]`. Ведь коэффициенты разные.
    - 4й тип отличается: У мужчин лобок, у женщин изгиб талии. У женщин лобок входит в гениталии, т.е. открытый лобок будет 4.0 / 2 = 2.0.
  - Элементы показываются в 2 колонки по 4.
  - Каждый элемент состоит из двух строк:
    1. Название.
    2. Коэффициент + поле ввода + чекбокс.
      - У чекбокса 3 состояния: галочка, ничего, 1/2 (для полуобнажённых частей тела).
  - Внизу взвешенная сумма по всем элементам.
2. pfg—Framing
  - p  Поза
  - f  Камера
  - g  Взгляд
  - Для каждого пункта раскрыты все элементы в виде чекбоксов (хотя по сути это выбор из списка).
  - В самом низу max → pfg
3. D — Design
  - Архетипы
  - Материалы
  - Маркеры
  - Все составляющие раскрыты до элементарных элементов.
  - В самом низу: Σ → число
4. Параметры:
  - Вычисленные N, pfg, D, которые можно менять.
  - К ним добавляется возможность ввести A вручную или через чекбоксы.
5. Score. Не входит в панель ввода, а отображается отдельно.
  - P нигде не отображается, так и задумано для экономии места и мыслетоплива.
  - S, AI: выше под картинкой.

Четыре столбика в горизонтальном flex-контейнере `.calc-flow`. На мобильных — вертикальная раскладка. Данные заполняются автоматически из ответа API или вводятся вручную. При ручном вводе итогового поля (N, pfg) автовычисление из компонент приостанавливается (флаги `zoneManualOverride`, `pfgManualOverride`).

---

## Входные параметры

### N (Nudity) — степень наготы

Вычисляется как взвешенная сумма по 8 анатомическим зонам. Для каждой зоны задаётся степень открытости (0–1), умноженная на весовой коэффициент зоны. Коэффициенты зависят от выбранного пола.

| Зона           | Жен.  | Муж.  |
|----------------|-------|-------|
| Ступни         | 0.5   | 0.2   |
| Бёдра          | 1.4   | 1.2   |
| Гениталии      | 4.0   | 4.0   |
| Талия / Лобок  | 1.0   | 1.0   |
| Ягодицы        | 2.0   | 1.5   |
| Живот          | 0.7   | 0.9   |
| Грудь          | 2.5   | 0.2   |
| Соски/ареолы   | 4.0   | 0.5   |

Важно: Талия у женщин; Лобок у мужчин. При этом Гениталии + лобок у женщин; Просто гениталии у мужчин.

```
N = Σ (weight_зоны × openness_зоны)
```

N не ограничен сверху в вычислении, но при подстановке в формулу P зажимается до 10. Переключатель пола (Жен/Муж) меняет весовые коэффициенты в UI и пересчитывает сумму. Зоны в UI расположены сеткой 2×4.

### pfg (Framing) — сексуальность подачи

Вычисляется как максимум трёх компонент, каждая по шкале 0–10:

| Компонента | Шкала |
|---|---|
| **p** — Поза тела | 0 функц. · 2 презент. · 5 акцент. · 7 секс. · 10 порно |
| **f** — Фрейминг камеры | 0 нейтр. · 3 эстетиз. · 5 анатомиз. · 8 POV · 10 порно |
| **g** — Взгляд/мимика | 0 нейтр. · 1 контакт. · 4 приглаш. · 7 секс. · 10 порно |

```
pfg = max(p, f, g)
```

### D (Design) — сексуализация костюма/атрибутики

Сумма маркеров, обрезается до 10. Архетипы (школьница 1, горничная 1, bunny-suit 2, боевой купальник 2, микробикини 3), материалы (прозрачная ткань 1, кожа 2, латекс 3), маркеры (BDSM 3, body writing 3, секс-игрушка в костюме 5).

### A (Actions) — явность сексуальных действий

Дискретная шкала: 0 нет · 2 сигнал без контакта · 4 первый контакт · 5 прямой контакт с эрогенными зонами · 7 фрикции · 9 проникновение · 10 экстремальные практики.

### NSFW — независимая AI-оценка

Модель возвращает поле `NSFW` (0–1) — общая субъективная оценка сексуализации изображения, не зависящая от формулы. Используется как нижняя граница Score (подстраховка) и отображается в UI как «Мнение AI» (умноженное на 10).

### Весовые коэффициенты

| Коэфф. | Умолч. | Назначение |
|--------|--------|------------|
| wn | 0.9 | Макс. вклад Nudity в P |
| wf | 0.6 | Макс. вклад Framing в P |
| wd | 0.6 | Макс. вклад Design в P |

Блокируются чекбоксом «Зафиксировать коэффициенты» (вкл. по умолчанию). Поля wn/wf/wd скрыты в div с `display:none`, их значения отображаются рядом с N, pfg, D как текстовые метки `×0.9` и т.д.

---

## Формулы

Все параметры нормализуются `÷ 10` перед подстановкой.

**Presentation** — промежуточная оценка визуального контекста (noisy-OR):

```
P = 1 − (1 − wn·N)(1 − wf·pfg)(1 − wd·D)
```

**Score** — итоговый балл (noisy-OR):

```
S = 1 − (1 − A)(1 − P)
```

**Подстраховка NSFW:** если `S < NSFW`, то `S = NSFW`.

Результат `S` умножается на 10 для шкалы 0–10.

Noisy-OR: если хотя бы один фактор максимален, итог стремится к максимуму. Факторы усиливают друг друга без выхода за границы диапазона.

---

## Архитектура кода

Однофайловый HTML без фреймворков. Шрифты: JetBrains Mono (моно), IBM Plex Sans (заголовки). Тёмная тема с акцентом `#f0a050`.

### 1. UI / разметка

Основные секции сверху вниз:

1. **Блок загрузки изображения** (`#dropSection`) — drop-зона с превью, статус-строка, имя модели, баланс, прогресс-бар.
2. **Итоговая панель** (`.final-score`) — крупное число Score, градиентная полоса (янтарный → красный), строка «Мнение AI» (скрыта до первого ответа).
3. **Чекбокс блокировки коэффициентов** (`.lock-row`).
4. **Поток вычислений** (`.calc-flow`) — четыре горизонтальных блока:
   - `.flow-block-n` — N: переключатель пола, сетка 2×4 зон, итоговая сумма.
   - `.flow-block-pfg` — pfg: три поля (p, f, g), итоговый max.
   - `.flow-block-sum` — сводка параметров: N, pfg, D (с весами), разделитель, A. Скрытые поля wn/wf/wd.
   - `.flow-block-score` — результаты: P, разделитель, S, строка AI.
5. **Легенда** (`.legend`) — описание всех параметров и формул.
6. **API Key** (`#keySection`) — поле ввода ключа, кнопка Save, статус.
7. **Футер** — ссылка на документацию.

### 2. Вычислительное ядро

**`sanitize(e)`** — фильтрует нечисловые символы при вводе, запрещает вторую точку.

**`val(id, max)`** — считывает поле, зажимает в `[0, max]`, возвращает 0 при NaN.

**`calcNudity()`** — считает `Σ(weight × openness)` по 8 зонам с учётом текущего пола (`currentSex`), записывает в `#nSum`. Если `zoneManualOverride = false`, записывает `min(10, sum)` в поле N и вызывает `calc()`.

**`calcPfg()`** — считает `max(p, f, g)`, записывает в `#pfgCalc`. Если `pfgManualOverride = false`, записывает в поле pfg и вызывает `calc()`.

**`calc()`** — главная функция. Читает N, pfg, D, A, wn, wf, wd; вычисляет P и S; применяет подстраховку NSFW; обновляет DOM: `#presOut`, `#sOut`, `#scoreOut`, `#scoreBar` (ширина и цвет hsl).

**Флаги override:**
- `zoneManualOverride` — ставится в `true` при ручном вводе в поле N; сбрасывается при вводе в зону.
- `pfgManualOverride` — аналогично для pfg и компонент p/f/g.

**Массив `ZONES`** — 8 объектов `{ id, f, m }` с весами для женского и мужского пола. Переключатель пола (`.sex-btn`) меняет `currentSex`, обновляет текстовые метки весов, пересчитывает N.

При загрузке (`DOMContentLoaded`): поля данных = 0, коэффициенты = дефолт, вызов `calc()`, запрос баланса.

### 3. Слой работы с API

```
Пользователь (drop / paste / click)
  → processFile(file)
      → превью в drop-зоне
      → resizeIfNeeded(file)  → { base64, mediaType, width, height }
          → analyzeImage(key, base64, mediaType)  → fetch OpenRouter
              → JSON { N, pfg, D, A, name, N_arr, pfg_arr, NSFW }
                  → applyScores({ N, pfg, D, A, N_arr, pfg_arr })
                      → зоны из N_arr, компоненты из pfg_arr
                      → calc() → P, S → DOM
```

**Источники изображения** — три обработчика: `drop` на `.drop-zone`, `change` на скрытом `<input type="file">`, `paste` на `document` (перехват изображения из буфера обмена).

**`resizeIfNeeded(file)`** — если min(w,h) < 1200 или max(w,h) > 1568, масштабирует через canvas с коэффициентом `1568 / max(w, h)`, конвертирует в JPEG (quality 0.92). Иначе читает оригинал. Возвращает `{ base64, mediaType, width, height }`.

**`analyzeImage(key, base64, mediaType)`** — запрос к `openrouter.ai/api/v1/chat/completions`:
- Модель: `anthropic/claude-opus-4.6`, провайдер `google-vertex`, без fallback.
- `temperature: 0`, `seed: 42`, `max_tokens: 500`, `reasoning.effort: "none"`.
- Заголовки `HTTP-Referer` / `X-Title` зависят от origin: `mariskori.github.io` → `NSFW calculator`, прочие http → `NSFL calculator`, file:// → `Local-host`.
- System prompt (`ANALYZE_PROMPT`) содержит полное описание шкал и формата JSON-ответа.
- URL запроса: `localStorage.testURL` (для отладки) или `https://openrouter.ai/api/v1/chat/completions`.

Обработка ответа:
1. Стрипает markdown-обёртки (` ```json ``` `).
2. Проверяет обязательные числовые поля N, pfg, D, A.
3. Обнаруживает отказ модели по паттернам (`I'm sorry`, `I cannot`, `I can't`, `I'm not able to`, `missingkids.org`) — возвращает `{A: 10, name: 'Слишком горячая!'}`.
4. Раскладывает `N_arr` (8 элементов) в объект `N_keys` с русскими названиями зон.
5. Добавляет `prompt_tokens` / `completion_tokens` в результат.

**`applyScores({ N, pfg, D, A, N_arr, pfg_arr })`:**
1. Если есть `N_arr` (массив из 8 элементов) — вычисляет openness для каждой зоны как `contribution / weight`, заполняет поля зон, сбрасывает override, вызывает `calcNudity()`.
2. Перезаписывает поле N точным значением от модели, ставит `zoneManualOverride = true`.
3. Если есть `pfg_arr` (массив из 3) — заполняет p, f, g, сбрасывает override, вызывает `calcPfg()`.
4. Перезаписывает pfg точным значением, ставит `pfgManualOverride = true`.
5. Заполняет D, A, вызывает `calc()`.
6. Показывает «Мнение AI» (NSFW × 10) в верхней панели и в блоке Score.

**Подсчёт стоимости.** Объект `PRICE` хранит цены за 1M токенов (для `claude-opus-4.6`: input $5, output $25). После ответа `MONEY.spent` увеличивается, `MONEY.balance` пересчитывается и выводится в `#balanceStatus`.

**`checkOpenRouterKey(apiKey)`** — GET-запрос к `/api/v1/auth/key`, возвращает лимиты/использование. Вызывается при `DOMContentLoaded` для получения начального баланса (`limit_remaining`).

### 4. Состояние и хранилище

Состояние полностью в DOM. Глобальные переменные:
- `GLOBAL_TEXT` — последний сырой текст ответа модели (для отладки в консоли).
- `GLOBAL_JSON` — распарсенный JSON последнего ответа. Используется для подстраховки NSFW в `calc()` и для отображения «Мнение AI».
- `GLOBAL_RESP` — объект Response последнего запроса.
- `currentSex` — `'f'` или `'m'`, выбранный пол.
- `zoneManualOverride` / `pfgManualOverride` — флаги ручного ввода.
- `MONEY` — объект `{ deposit, spent, balance }`.

`localStorage`:
- `keyNSFW` — API-ключ OpenRouter.
- `testURL` — (опцион.) альтернативный URL для fetch (отладка).

---

## Прогресс-бар

Fake progress — имитация двумя фазами CSS-перехода:

1. **Фаза 1:** 0% → 80% за 5 с, `transition: linear`.
2. **Фаза 2:** 80% → 98% за 5 с, `transition: ease-out` (замедление).
3. **Завершение:** мгновенный переход до 100%, затем скрытие через 300 мс.

Таймер `fakeProgressTimer` очищается при ошибке (`resetFakeProgress`) или успехе (`finishFakeProgress`). Перед запуском — сброс через `void bar.offsetWidth` (форсированный reflow).

---

## Обработка ошибок API

- HTTP-ошибки: из тела ответа извлекается `error.message`. Поля `user_id` и `error.metadata` удаляются из объекта перед выводом.
- `requires more credits` / `Key limit exceeded` → «Не хватает денег на счету».
- Прочие ошибки — выводятся как есть.
- Ошибка чтения файла — отдельный catch.

---

## Полный поток данных

```
Пользователь (drop / paste / click)
  → processFile(file)
      → превью в drop-зоне
      → resizeIfNeeded → { base64, mediaType, width, height }
          → analyzeImage → fetch OpenRouter (Vision-модель)
              → JSON { N, N_arr, pfg, pfg_arr, D, A, NSFW, name }
                  → applyScores
                      → N_arr → 8 зон (openness) → calcNudity() → N → calc()
                      → pfg_arr → p, f, g → calcPfg() → pfg → calc()
                      → D, A → calc()
                          → P, S → DOM (#presOut, #sOut, #scoreOut, #scoreBar)
                          → NSFW → подстраховка S, «Мнение AI»
                          → стоимость → #balanceStatus
```
