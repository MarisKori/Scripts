# NSFW Score Calculator — Техническая документация

## Назначение

Интерактивный калькулятор для оценки уровня NSFW-контента по числовой шкале 0–10. Предназначен для ручной разметки изображений или видеокадров. Результат — единый агрегированный скор, вычисляемый по двухуровневой формуле на основе Noisy-OR из теории байесовских сетей.

---

## Математическая модель

### Принцип: Noisy-OR

Noisy-OR — формула из байесовских сетей для агрегации независимых причин, каждая из которых способна самостоятельно вызвать эффект:

```
P(эффект) = 1 − ∏ (1 − pᵢ)
```

Свойства по сравнению с `max()` и средним:
- если только один сигнал ненулевой — результат примерно равен ему;
- если несколько сигналов ненулевые — они усиливают друг друга;
- результат никогда не превышает 1.

### Уровень 1 — Presentation (P)

Агрегирует три визуальных аспекта подачи тела: нагота, поза/ракурс, дизайн.

```
P = 1 − (1 − wn·N) × (1 − wf·F) × (1 − wd·D)
```

Где `N`, `F`, `D` ∈ [0, 1] — нормализованные входные значения (делятся на 10 перед подстановкой).  
Весовые коэффициенты `wn`, `wf`, `wd` ограничивают **максимальный вклад** каждого фактора: при `wn = 0.9` нагота при максимуме N = 10 даёт вклад не более 0.9.

### Уровень 2 — Score (S)

Агрегирует Actions (явность сексуальных действий) и Presentation как два независимых пути к NSFW.

```
S = 1 − (1 − A) × (1 − P)
```

Где `A` ∈ [0, 1] — нормализованное значение Actions.  
Итоговый скор умножается на 10 для отображения в шкале 0–10.

### Параметры по умолчанию

| Параметр | Значение | Смысл |
|----------|----------|-------|
| `wn` | 0.9 | Нагота — основной сигнал, максимальный вклад 90% |
| `wf` | 0.6 | Фрейминг — средний вес |
| `wd` | 0.6 | Дизайн — средний вес |

---

## Входные параметры

| Обозначение | Диапазон | Описание |
|-------------|----------|----------|
| **N** — Nudity | 0–10 | Степень наготы: от полностью закрытой одежды (0) до генитального крупного плана (10) |
| **F** — Framing | 0–10 | Сексуальность позы, ракурса, фокуса камеры: от паспортного фото (0) до порнографического фрейминга (10) |
| **D** — Design | 0–10 | Сексуализированность костюма, пропорций, атрибутики: от нейтрального дизайна (0) до порнографического (10) |
| **A** — Actions | 0–10 | Явность сексуальных действий: от отсутствия (0) до экстремальных практик крупным планом (10) |

Коэффициенты `wn`, `wf`, `wd` по умолчанию заблокированы, разблокируются чекбоксом «Зафиксировать коэффициенты».

---

## Структура HTML-файла

Файл — единый self-contained HTML без внешних зависимостей кроме Google Fonts.

```
nsfw-calculator.html
├── <head>
│   ├── Google Fonts (JetBrains Mono, IBM Plex Sans)
│   └── <style> — все стили (CSS custom properties, layout, компоненты)
└── <body>
    ├── .container
    │   ├── <h1> — заголовок
    │   ├── .lock-row — чекбокс блокировки коэффициентов
    │   ├── .section#presentation — формула P с инлайн-полями ввода
    │   ├── .section#score — формула S с инлайн-полями ввода
    │   ├── .final-score — блок итогового скора с прогресс-баром
    │   ├── .legend — таблица-легенда переменных
    │   └── шкалы N / F / D / A (.scale-block × 4)
    └── <script> — вся логика (~50 строк)
```

---

## Структура JavaScript

Весь JS — одиночный инлайн-скрипт в конце `<body>`, ~50 строк.

### Утилиты

```js
const $ = id => document.getElementById(id)
```
Сокращение для `getElementById`.

```js
function sanitize(e)
```
Обработчик `input`: очищает поле от нечисловых символов, запрещает более одной точки.

```js
function val(id, max)
```
Читает значение поля по `id`, парсит как `float`, клампит в диапазон `[0, max]`. Возвращает `0` при `NaN`.

### Основная логика

```js
function calc()
```
Вычисляет `P` и `S` по формулам, обновляет DOM:
- `#presOut` — промежуточный результат P × 10;
- `#scoreOut` — итоговый S × 10;
- `#scoreBar` — ширина и цвет полосы (hsl от жёлтого к красному по мере роста S).

### Инициализация

```js
allFields.forEach(id => {
  $(id).addEventListener('input', e => { sanitize(e); calc(); })
})
```
Вешает обработчики на все 7 полей (4 данных + 3 коэффициента). Пересчёт — при каждом изменении.

```js
$('lockCoeffs').addEventListener('change', e => { ... })
```
Чекбокс переключает `disabled` на полях коэффициентов.

```js
calc()  // вызов при загрузке страницы
```

### Цветовая индикация

Цвет полосы `#scoreBar` вычисляется как HSL:

```js
const hue = 40 - S * 40   // 40 (жёлтый) → 0 (красный)
const sat = 60 + S * 30   // 60% → 90%
```

---

## CSS-архитектура

Стили описаны через CSS custom properties в `:root`:

```css
--bg, --surface, --surface-2   /* фоновые слои */
--border                        /* цвет границ */
--text, --text-dim              /* текст */
--accent, --accent-dim          /* оранжевый акцент */
--input-bg, --input-locked      /* фон полей */
--result-bg, --result-border    /* фон результатов */
--mono, --sans                  /* шрифты */
```

Ключевые компоненты:
- `.formula-row` — flex-строка с инлайн-полями прямо внутри формулы;
- `input.coeff` — визуально отличается от полей данных (тёмный фон, оранжевый текст);
- `.result-inline` — небольшой бейдж для промежуточного результата P;
- `.score-big` — крупный итоговый скор;
- `.score-bar-wrap / .score-bar` — прогресс-бар с анимацией `transition: width 0.2s ease`;
- `.scale-block / .scale-row` — таблица шкал в нижней части страницы.

---

## Калибровка весов

Стартовые значения `wn = 0.9`, `wf = 0.6`, `wd = 0.6` выбраны экспертно. Для точной калибровки необходима размеченная выборка изображений с эталонными оценками. Процедура: минимизация MSE между `S_calc` и `S_expert` по параметрам `wn`, `wf`, `wd` ∈ [0, 1].
